<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ระบบเสนอแฟ้มผู้อำนวยการ</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>
body{font-family:'Prompt',sans-serif;background:#f4f6f9;}
.navbar{background:#0d2c6c;}
canvas{border:1px solid #ccc;border-radius:8px;width:100%;background:#fff;touch-action:none;}
.spinner-border-sm{width:1rem;height:1rem;}
</style>
</head>
<body>

<nav class="navbar navbar-dark px-3">
<span class="navbar-brand">ระบบเสนอแฟ้มผู้อำนวยการ</span>
<div>
<button class="btn btn-light btn-sm me-2" onclick="openQRModal()">สร้างคิวอาร์โค้ด</button>
<button class="btn btn-warning btn-sm" onclick="openOfficer()">ระบบเจ้าหน้าที่</button>
</div>
</nav>

<div class="container mt-4">
<ul class="nav nav-tabs">
<li class="nav-item"><button class="nav-link active" onclick="loadList('waiting')">รอพิจารณา</button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('approved')">พิจารณาแล้ว</button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('returned')">รับแฟ้มคืนแล้ว</button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('all')">ทั้งหมด</button></li>
</ul>

<div id="registerPage"></div>
<div id="listArea" class="mt-3"></div>
<div id="officerArea" class="mt-3"></div>
</div>

<!-- QR MODAL -->
<div class="modal fade" id="qrModal">
<div class="modal-dialog">
<div class="modal-content p-3">
<h5>สร้างคิวอาร์โค้ด</h5>
<div>รหัสแฟ้ม: <b id="newFileId"></b></div>
<input id="groupName" class="form-control mt-2" placeholder="ชื่อกลุ่มงาน">
<button class="btn btn-primary mt-3" onclick="createQR(this)">
<span>สร้าง</span>
<span class="spinner-border spinner-border-sm d-none"></span>
</button>
<div id="qrBox" class="text-center mt-3"></div>
<div id="qrDownload" class="text-center mt-2"></div>
</div>
</div>
</div>

<!-- LOGIN -->
<div class="modal fade" id="loginModal">
<div class="modal-dialog">
<div class="modal-content p-3">
<h5>เข้าสู่ระบบเจ้าหน้าที่</h5>
<input id="phone" class="form-control mb-2" placeholder="เบอร์โทร">
<button class="btn btn-primary" onclick="login(this)">
<span>เข้าสู่ระบบ</span>
<span class="spinner-border spinner-border-sm d-none"></span>
</button>
</div>
</div>
</div>

<!-- RETURN -->
<div class="modal fade" id="returnModal">
<div class="modal-dialog modal-lg">
<div class="modal-content p-3">
<h5>รับแฟ้มคืน</h5>
<input id="receiver" class="form-control mb-2" placeholder="ชื่อผู้รับ">
<canvas id="sigCanvas" height="250"></canvas>
<div class="mt-2">
<button class="btn btn-secondary btn-sm" onclick="signaturePad.clear()">ล้างลายเซ็น</button>
<button class="btn btn-primary btn-sm" onclick="submitReturn(this)">
<span>บันทึก</span>
<span class="spinner-border spinner-border-sm d-none"></span>
</button>
</div>
</div>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxK4PsIqeO6C_v2n6MpqE1tEeT437DxrjVP7ywbV2Jk3IShxea1ClzfeLcNVSyxCb9F/exec";
let globalData=[],signaturePad,currentFileId=null;

/* Spinner */
function spin(btn,on){
const sp=btn.querySelector(".spinner-border");
if(!sp)return;
if(on){btn.disabled=true;sp.classList.remove("d-none");}
else{btn.disabled=false;sp.classList.add("d-none");}
}

/* Date Thai */
function formatThaiDate(str){
if(!str) return "";
let d=new Date(str);
if(isNaN(d)) return str;
const m=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
return `${d.getDate()} ${m[d.getMonth()]} ${d.getFullYear()+543}`;
}

function getStatusThai(s){
if(s=="waiting") return `<span class="badge bg-warning text-dark">รอพิจารณา</span>`;
if(s=="approved") return `<span class="badge bg-success">พิจารณาแล้ว</span>`;
if(s=="returned") return `<span class="badge bg-primary">รับแฟ้มคืนแล้ว</span>`;
return s;
}

/* INIT */
window.onload=async()=>{
await checkQRScan();
await loadDashboard();
};

/* DASHBOARD */
async function loadDashboard(){
globalData=await fetch(API_URL+"?action=getAll").then(r=>r.json());
loadList("waiting");
}

function loadList(type){
officerArea.innerHTML="";
let data=type=="all"?[...globalData]:globalData.filter(d=>d.status==type);
data.sort((a,b)=> new Date(b.submitDate||0)-new Date(a.submitDate||0));

let html=`<table class="table table-bordered">
<tr><th>รหัส</th><th>วันที่เสนอ</th><th>ผู้เสนอ</th>
${type=="approved"?"<th>วันที่ออก</th>":""}
<th>สถานะ</th><th>จัดการ</th></tr>`;

data.forEach(d=>{
html+=`<tr>
<td>${d.fileId}</td>
<td>${formatThaiDate(d.submitDate)}</td>
<td>${d.proposer||""}</td>
${type=="approved"?`<td>${formatThaiDate(d.outDate)}</td>`:""}
<td>${getStatusThai(d.status)}</td>
<td>
${d.status=="approved"?`<button class="btn btn-primary btn-sm" onclick="openReturn('${d.fileId}')">รับแฟ้มคืน</button>`:""}
</td>
</tr>`;
});
html+="</table>";
listArea.innerHTML=html;
}

/* QR SYSTEM */
async function openQRModal(){
new bootstrap.Modal(qrModal).show();
let res=await fetch(API_URL+"?action=generateFileId").then(r=>r.json());
newFileId.innerText=res.fileId;
currentFileId=res.fileId;
}

async function createQR(btn){
spin(btn,true);

await fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"createFile",
fileId:currentFileId,
department:groupName.value
})});

qrBox.innerHTML="";
let url=location.origin+location.pathname+"?fileId="+currentFileId;

new QRCode(qrBox,{text:url,width:220,height:220});

setTimeout(()=>{
let canvas=qrBox.querySelector("canvas");
let img=canvas.toDataURL("image/png");
qrDownload.innerHTML=`
<a href="${img}" download="${currentFileId}.png" class="btn btn-success btn-sm">ดาวน์โหลด</a>
<button onclick="window.print()" class="btn btn-primary btn-sm">พิมพ์</button>`;
},300);

spin(btn,false);
}

/* Officer */
function openOfficer(){
if(!sessionStorage.getItem("officer")){
new bootstrap.Modal(loginModal).show();
return;
}
loadOfficer();
}

async function login(btn){
spin(btn,true);
sessionStorage.setItem("officer","1");
bootstrap.Modal.getInstance(loginModal).hide();
spin(btn,false);
loadOfficer();
}

function loadOfficer(){
let waiting=globalData.filter(d=>d.status=="waiting");
let html=`<h5>แฟ้มรอพิจารณา</h5>
<table class="table table-bordered">
<tr><th>รหัส</th><th>วันที่เสนอ</th><th>ผู้เสนอ</th><th>วันที่ออก</th><th></th></tr>`;
waiting.forEach(d=>{
html+=`<tr>
<td>${d.fileId}</td>
<td>${formatThaiDate(d.submitDate)}</td>
<td>${d.proposer}</td>
<td><input type="date" id="out_${d.fileId}"></td>
<td><button class="btn btn-success btn-sm" onclick="approve('${d.fileId}',this)">
<span>บันทึก</span>
<span class="spinner-border spinner-border-sm d-none"></span>
</button></td>
</tr>`;
});
html+="</table>";
officerArea.innerHTML=html;
}

async function approve(id,btn){
spin(btn,true);
await fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"updateApproved",
fileId:id,
outDate:document.getElementById("out_"+id).value
})});
await loadDashboard();
loadOfficer();
spin(btn,false);
}

/* RETURN */
function openReturn(id){
currentFileId=id;
setTimeout(()=>{
const canvas=document.getElementById("sigCanvas");
const ratio=Math.max(window.devicePixelRatio||1,1);
canvas.width=canvas.offsetWidth*ratio;
canvas.height=250*ratio;
canvas.getContext("2d").scale(ratio,ratio);
signaturePad=new SignaturePad(canvas,{minWidth:1,maxWidth:2.5,penColor:"#000"});
},300);
new bootstrap.Modal(returnModal).show();
}

async function submitReturn(btn){
if(signaturePad.isEmpty()) return alert("กรุณาเซ็นก่อน");
spin(btn,true);
await fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"updateReturned",
fileId:currentFileId,
receiver:receiver.value,
signature:signaturePad.toDataURL()
})});
bootstrap.Modal.getInstance(returnModal).hide();
await loadDashboard();
spin(btn,false);
}

/* QR SCAN */
async function checkQRScan(){
const id=new URLSearchParams(location.search).get("fileId");
if(!id)return;
const res=await fetch(API_URL+"?action=getStatus&fileId="+id).then(r=>r.json());
if(!res.status||res.status=="returned"){
registerPage.innerHTML=`
<div class="card p-3 mt-3">
<h5>ลงทะเบียนเสนอแฟ้ม ผอ.</h5>
<div>รหัสแฟ้ม: <b>${id}</b></div>
<input type="date" id="submitDate" class="form-control mt-2">
<input id="proposer" class="form-control mt-2" placeholder="ผู้เสนอ">
<button class="btn btn-primary mt-3" onclick="submitRegister('${id}',this)">
<span>บันทึก</span>
<span class="spinner-border spinner-border-sm d-none"></span>
</button>
</div>`;
}
}

async function submitRegister(id,btn){
spin(btn,true);
await fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"register",
fileId:id,
submitDate:submitDate.value,
proposer:proposer.value
})});
location.href=location.pathname;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
