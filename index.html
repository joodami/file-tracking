<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ระบบเสนอแฟ้มผู้อำนวยการ</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
body{font-family:'Prompt',sans-serif;background:#f4f6f9;}
.navbar{background:#0d2c6c;}
.card{border:none;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.btn-primary{background:#0d2c6c;border:none;}
.stat-card{border-left:5px solid #c5a100;}
.hidden{display:none;}
.badge-gold{background:#c5a100;}
canvas{border:1px solid #ddd;border-radius:8px;}
</style>
</head>

<body>

<nav class="navbar navbar-dark px-3">
<span class="navbar-brand">ระบบเสนอแฟ้มผู้อำนวยการ</span>
<button class="btn btn-warning btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container mt-4">

<!-- LOGIN -->
<div id="loginPage" class="hidden">
<div class="card p-4 mx-auto" style="max-width:350px">
<h5 class="text-center">เข้าสู่ระบบ</h5>
<input id="phone" class="form-control mt-3" placeholder="เบอร์โทร">
<button class="btn btn-primary w-100 mt-3" onclick="login()">Login</button>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden">

<ul class="nav nav-tabs" id="tabs">
<li class="nav-item"><button class="nav-link active" onclick="loadList('waiting')">รอพิจารณา <span class="badge bg-warning" id="bWaiting">0</span></button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('approved')">พิจารณาแล้ว <span class="badge bg-success" id="bApproved">0</span></button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('returned')">รับคืนแล้ว <span class="badge bg-primary" id="bReturned">0</span></button></li>
<li class="nav-item"><button class="nav-link" onclick="loadList('all')">ทั้งหมด <span class="badge badge-gold" id="bAll">0</span></button></li>
</ul>

<div id="listArea" class="mt-3"></div>

<hr>

<h5>สร้างแฟ้มใหม่</h5>
<input id="department" class="form-control mt-2" placeholder="หน่วยงาน">
<input id="creator" class="form-control mt-2" placeholder="ผู้สร้าง">
<button class="btn btn-primary mt-3" onclick="createFile()">สร้าง + QR</button>
<div id="qr" class="mt-4"></div>

</div>

<!-- REGISTER PAGE -->
<div id="registerPage" class="hidden">
<div class="card p-4">
<h5>ลงทะเบียนเสนอแฟ้ม ผอ.</h5>
<input id="proposer" class="form-control mt-2" placeholder="ชื่อผู้เสนอ">
<textarea id="remark" class="form-control mt-2" placeholder="หมายเหตุ"></textarea>
<button class="btn btn-primary mt-3" onclick="registerFile()">บันทึกเสนอแฟ้ม</button>
</div>
</div>

<!-- RETURN PAGE -->
<div id="returnPage" class="hidden">
<div class="card p-4">
<h5>รับแฟ้มคืน</h5>
<input id="receiver" class="form-control mt-2" placeholder="ชื่อผู้รับ">
<canvas id="signatureCanvas" height="150"></canvas>
<button class="btn btn-secondary mt-2" onclick="signaturePad.clear()">ล้าง</button>
<button class="btn btn-primary mt-2" onclick="submitReturn()">บันทึก</button>
</div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL="https://script.google.com/macros/s/AKfycbxK4PsIqeO6C_v2n6MpqE1tEeT437DxrjVP7ywbV2Jk3IShxea1ClzfeLcNVSyxCb9F/exec";

/* ================= API ================= */
async function apiGet(action,param=""){
const res=await fetch(`${API_URL}?action=${action}${param}`);
return res.json();
}
async function apiPost(data){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify(data)});
return res.json();
}

/* ================= AUTH ================= */
async function login(){
const phone=phoneInput.value;
const res=await apiPost({action:"login",phone});
if(res.success){
sessionStorage.setItem("user",res.name);
showDashboard();
}else alert("ไม่พบข้อมูล");
}
function logout(){sessionStorage.clear();location.href=location.pathname;}
function checkLogin(){
if(sessionStorage.getItem("user")) showDashboard();
else showLogin();
}
function showLogin(){
hideAll();loginPage.classList.remove("hidden");
}
function showDashboard(){
hideAll();dashboardPage.classList.remove("hidden");
loadDashboard();
}
function hideAll(){
loginPage.classList.add("hidden");
dashboardPage.classList.add("hidden");
registerPage.classList.add("hidden");
returnPage.classList.add("hidden");
}

/* ================= DASHBOARD ================= */
let globalData=[];
async function loadDashboard(){
globalData=await apiGet("getAll");
updateBadges();
loadList("waiting");
}
function updateBadges(){
let w=0,a=0,r=0;
globalData.forEach(d=>{
if(d.status=="waiting")w++;
if(d.status=="approved")a++;
if(d.status=="returned")r++;
});
bWaiting.innerText=w;
bApproved.innerText=a;
bReturned.innerText=r;
bAll.innerText=globalData.length;
}
function loadList(type){
let filtered=globalData;
if(type!="all")filtered=globalData.filter(d=>d.status==type);

let html=`<div class="table-responsive"><table class="table table-striped">
<thead><tr><th>รหัส</th><th>ผู้เสนอ</th><th>สถานะ</th><th>จัดการ</th></tr></thead><tbody>`;
filtered.forEach(d=>{
html+=`<tr>
<td>${d.fileId}</td>
<td>${d.proposer||""}</td>
<td>${d.status}</td>
<td>
${d.status=="waiting"?`<button class="btn btn-success btn-sm" onclick="approve('${d.fileId}')">อนุมัติ</button>`:""}
</td></tr>`;
});
html+="</tbody></table></div>";
listArea.innerHTML=html;
}
async function approve(id){
await apiPost({action:"updateApproved",fileId:id});
loadDashboard();
}

/* ================= CREATE FILE ================= */
async function createFile(){
const gen=await apiGet("generateFileId");
const fileId=gen.fileId;
await apiPost({action:"createFile",fileId:fileId,fileName:"แฟ้มเสนอผอ.",department:department.value,creator:creator.value});
qr.innerHTML="";
new QRCode(qr,{text:`${location.origin}?fileId=${fileId}`,width:200,height:200});
}

/* ================= QR WORKFLOW ================= */
const urlParams=new URLSearchParams(window.location.search);
const fileId=urlParams.get("fileId");
if(fileId)checkStatus(fileId);

async function checkStatus(id){
const res=await apiGet("getStatus",`&fileId=${id}`);
if(!res.status){hideAll();registerPage.classList.remove("hidden");}
else if(res.status=="approved"){hideAll();returnPage.classList.remove("hidden");}
}

/* ================= REGISTER ================= */
async function registerFile(){
await apiPost({action:"register",fileId:fileId,proposer:proposer.value,remark:remark.value});
alert("บันทึกสำเร็จ");
location.href=location.pathname;
}

/* ================= RETURN ================= */
let signaturePad;
window.onload=function(){
checkLogin();
const canvas=document.getElementById("signatureCanvas");
if(canvas)signaturePad=new SignaturePad(canvas);
}
async function submitReturn(){
await apiPost({
action:"updateReturned",
fileId:fileId,
receiver:receiver.value,
signature:signaturePad.toDataURL()
});
alert("รับคืนเรียบร้อย");
location.href=location.pathname;
}
</script>

</body>
</html>
